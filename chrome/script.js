var calculateSpecificity=function(input){var selectors,selector,i,len,results=[];selectors=input.split(",");for(i=0,len=selectors.length;i<len;i+=1){selector=selectors[i];if(selector.length>0){results.push(calculateSingleSpecificity(selector))}}return results};var calculateSingleSpecificity=function(input){var selector=input,findMatch,typeCount={a:0,b:0,c:0},parts=[],attributeRegex=/(\[[^\]]+\])/g,idRegex=/(#[^\#\s\+>~\.\[:\)]+)/g,classRegex=/(\.[^\s\+>~\.\[:\)]+)/g,pseudoElementRegex=/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,pseudoClassWithBracketsRegex=/(:(?!not|global|local)[\w-]+\([^\)]*\))/gi,pseudoClassRegex=/(:(?!not|global|local)[^\s\+>~\.\[:]+)/g,elementRegex=/([^\s\+>~\.\[:]+)/g;findMatch=function(regex,type){var matches,i,len,match,index,length;if(regex.test(selector)){matches=selector.match(regex);for(i=0,len=matches.length;i<len;i+=1){typeCount[type]+=1;match=matches[i];index=selector.indexOf(match);length=match.length;parts.push({selector:input.substr(index,length),type:type,index:index,length:length});selector=selector.replace(match,Array(length+1).join(" "))}}};(function(){var replaceWithPlainText=function(regex){var matches,i,len,match;if(regex.test(selector)){matches=selector.match(regex);for(i=0,len=matches.length;i<len;i+=1){match=matches[i];selector=selector.replace(match,Array(match.length+1).join("A"))}}},escapeHexadecimalRegex=/\\[0-9A-Fa-f]{6}\s?/g,escapeHexadecimalRegex2=/\\[0-9A-Fa-f]{1,5}\s/g,escapeSpecialCharacter=/\\./g;replaceWithPlainText(escapeHexadecimalRegex);replaceWithPlainText(escapeHexadecimalRegex2);replaceWithPlainText(escapeSpecialCharacter)})();(function(){var regex=/{[^]*/gm,matches,i,len,match;if(regex.test(selector)){matches=selector.match(regex);for(i=0,len=matches.length;i<len;i+=1){match=matches[i];selector=selector.replace(match,Array(match.length+1).join(" "))}}})();findMatch(attributeRegex,"b");findMatch(idRegex,"a");findMatch(classRegex,"b");findMatch(pseudoElementRegex,"c");findMatch(pseudoClassWithBracketsRegex,"b");findMatch(pseudoClassRegex,"b");selector=selector.replace(/[\*\s\+>~]/g," ");selector=selector.replace(/[#\.]/g," ");selector=selector.replace(/:not/g,"    ");selector=selector.replace(/:local/g,"      ");selector=selector.replace(/:global/g,"       ");selector=selector.replace(/[\(\)]/g," ");findMatch(elementRegex,"c");parts.sort(function(a,b){return a.index-b.index});return{selector:input,specificity:"0,"+typeCount.a.toString()+","+typeCount.b.toString()+","+typeCount.c.toString(),specificityArray:[0,typeCount.a,typeCount.b,typeCount.c],parts:parts}};var compareSpecificity=function(a,b){var aSpecificity,bSpecificity,i;if(typeof a==="string"){if(a.indexOf(",")!==-1){throw"Invalid CSS selector"}else{aSpecificity=calculateSingleSpecificity(a)["specificityArray"]}}else if(Array.isArray(a)){if(a.filter(function(e){return typeof e==="number"}).length!==4){throw"Invalid specificity array"}else{aSpecificity=a}}else{throw"Invalid CSS selector or specificity array"}if(typeof b==="string"){if(b.indexOf(",")!==-1){throw"Invalid CSS selector"}else{bSpecificity=calculateSingleSpecificity(b)["specificityArray"]}}else if(Array.isArray(b)){if(b.filter(function(e){return typeof e==="number"}).length!==4){throw"Invalid specificity array"}else{bSpecificity=b}}else{throw"Invalid CSS selector or specificity array"}for(i=0;i<4;i+=1){if(aSpecificity[i]<bSpecificity[i]){return-1}else if(aSpecificity[i]>bSpecificity[i]){return 1}}return 0};class Units{static getElementFontSize(context){return parseFloat(getComputedStyle(context||document.documentElement).fontSize)}static convertRem(value){var value=Units.parseValue(value,"rem")*Units.getElementFontSize();return value+"px"}static convertEm(value,context){var value=Units.parseValue(value,"em")*Units.getElementFontSize(context);return value+"px"}static convertEmContext(value,oldContext,newContext){var ratio=Units.getElementFontSize(oldContext)/Units.getElementFontSize(newContext);var newEm=Units.parseValue(value,"em")*ratio;return newEm+"em"}static parseValue(value,unit){return parseFloat(value.substring(0,value.indexOf(unit)))}}class StylesCalculator{static setup(){StylesCalculator.inheritableStyles=["azimuth","border-collapse","border-spacing","caption-side","color","cursor","direction","elevation","empty-cells","font-family","font-size","font-style","font-variant","font-weight","font","letter-spacing","line-height","list-style-image","list-style-position","list-style-type","list-style","orphans","pitch-range","pitch","quotes","richness","speak-header","speak-numeral","speak-punctuation","speak","speech-rate","stress","text-align","text-indent","text-transform","visibility","voice-family","volume","white-space","widows","word-spacing","-webkit-font-smoothing"];StylesCalculator.rules=[];StylesCalculator.sheets=document.styleSheets;StylesCalculator.defaultStyles={};for(var i in StylesCalculator.sheets){try{var rulesForSheet=StylesCalculator.sheets[i].rules||StylesCalculator.sheets[i].cssRules;for(var r in rulesForSheet){StylesCalculator.rules.push(rulesForSheet[r])}}catch(e){console.debug("Failed to fetch CSS rules for "+StylesCalculator.sheets[i].href+". Likely a CORS issue.")}}}constructor(node){this.node=node;this.declarations=[];this.styles={}}run(){this.findMatchingDeclarations();this.sortDeclarationsBySpecificity();this.mergeAndRemoveOverwrittenStyles();this.mergeInheritedStyles();return this.styles}findMatchingDeclarations(){for(var r in StylesCalculator.rules){if(!this.matches(StylesCalculator.rules[r].selectorText)){continue}var cssText=StylesCalculator.rules[r].cssText;var newDeclarations=this.extractDeclarations(cssText);this.declarations=this.declarations.concat(newDeclarations)}}sortDeclarationsBySpecificity(){this.declarations.sort(function(a,b){return compareSpecificity(a.selector,b.selector)})}mergeAndRemoveOverwrittenStyles(){var finalStyles=this.styles;for(var d in this.declarations){for(var r in this.declarations[d].rules){var value=this.declarations[d].rules[r];if(value=="inherit"){continue}finalStyles[r]=value}}return finalStyles}selectorsFromCSSText(cssText){return cssText.substr(0,cssText.indexOf(" {")).split(",")}rulesFromCSSText(cssText){var ruleKeyValues=cssText.substring(cssText.lastIndexOf("{ ")+2,cssText.lastIndexOf(" }")).split(";");var rules={};for(var i=0;i<ruleKeyValues.length;i++){var ruleParts=ruleKeyValues[i].trim().split(": ");if(!ruleParts[0]){continue}rules[ruleParts[0]]=ruleParts[1]}return rules}extractDeclarations(cssText){var selectors=this.selectorsFromCSSText(cssText);var declarations=[];for(var i=0;i<selectors.length;i++){var selector=selectors[i].trim();if(!this.matches(selector)){continue}declarations.push({selector:selector,rules:this.rulesFromCSSText(cssText)})}return declarations}matches(selector){return this.node.element.matches(selector)}mergeInheritedStyles(){for(var i=0;i<StylesCalculator.inheritableStyles.length;i++){var inheritableStyle=StylesCalculator.inheritableStyles[i];if(inheritableStyle in this.styles){continue}var currentNode=this.node.parent;var inheritableValue=currentNode?currentNode.styles[inheritableStyle]:null;while(currentNode&&!inheritableValue){currentNode=currentNode.parent;inheritableValue=currentNode?currentNode.styles[inheritableStyle]:null}if(inheritableValue){if(inheritableValue.endsWith("rem")){}else if(inheritableValue.endsWith("em")){inheritableValue=Units.convertEmContext(inheritableValue,currentNode.element,this.node.element)}this.styles[inheritableStyle]=inheritableValue}}}}StylesCalculator.setup();class StyleTreeNode{constructor(element,parent){this.parent=parent;this.element=element;this.tag=element.tagName.toLowerCase();this.id=element.id||null;this.classes=element.classList.value||null;this.name=element.name||null;this.children=[];this.element.matches=this.element.matches||this.element.webkitMatchesSelector||this.element.mozMatchesSelector||this.element.msMatchesSelector||this.element.oMatchesSelector;this.description=null}calculateStyles(){this.styles=new StylesCalculator(this).run()}defaultDescription(nodes){return this.description||this.matchingElementDescription(nodes)||this.name||this.id||""}matchingElementDescription(nodes){for(var i=0;i<nodes.length;i++){var node=nodes[i];var matches=node.description&&node.tag===this.tag&&node.classes===this.classes&&node.id===this.id;if(matches){return node.description}}return null}formattedDescription(){return this.description.trim().toLowerCase().replace(/ /g,"-").replace(/_/g,"-")}formattedStyles(){this.styles=this.sortStyles();var styleStrings=[];for(var s in this.styles){styleStrings.push("  "+s+": "+this.styles[s])}return styleStrings.join(";\n")+";"}sortStyles(){var self=this;var sorted={};Object.keys(this.styles).sort(this.selectorSorter).forEach(function(key){sorted[key]=self.styles[key]});return sorted}selectorSorter(a,b){if(a.length>b.length&&a.startsWith(b)){return 1}if(b.length>a.length&&b.startsWith(a)){return-1}return a.localeCompare(b)}}class StyleTree{constructor(html,block){this.root=new StyleTreeNode(html,null);this.root.calculateStyles();this.block=block;this.tree=this.root;this.list=[];this.excludedTags=["head","script","noscript","style","iframe","embed"];this.buildNodeTree(this.tree,false)}buildNodeTree(node,insideBlock){var self=this;var isBlock=node.element===this.block;if(isBlock){insideBlock=true;self.list.push(node)}var children=Array.prototype.slice.call(node.element.children);children.forEach(function(child){var childNode=new StyleTreeNode(child,node);if(self.shouldExcludeTag(childNode.tag)){return}childNode.calculateStyles();node.children.push(childNode);if(insideBlock){self.list.push(childNode)}self.buildNodeTree(childNode,insideBlock)})}shouldExcludeTag(tag){return this.excludedTags.includes(tag)}}class CSSExporter{constructor(nodes){this.nodes=nodes;this.blockNode=this.nodes.shift();this.blockName=this.blockNode.formattedDescription();this.content=null}export(){this.removeDuplicateNodes();this.content=this.buildContent();this.download()}toBEMSelector(node){return"."+this.blockName+"__"+node.formattedDescription()}buildContent(){var self=this;var groups=["."+this.blockName+" {\n"+this.blockNode.formattedStyles()+"\n}"];var elements=this.nodes.map(function(node){return self.toBEMSelector(node)+" {\n"+node.formattedStyles()+"\n}"});return groups.concat(elements).join("\n\n")+"\n"}download(){var downloadLink=document.createElement("a");downloadLink.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(this.content));downloadLink.setAttribute("download",this.blockName+".css");downloadLink.style.display="none";document.body.appendChild(downloadLink);downloadLink.click();document.body.removeChild(downloadLink)}removeDuplicateNodes(){var seen={};this.nodes=this.nodes.filter(function(node){var key=node.formattedDescription();return seen.hasOwnProperty(key)?false:seen[key]=true})}}class Dialog{constructor(block,nodes){this.block=block;this.nodes=nodes;this.index=0;this.dialog=null}start(){this.tidyUp();this.buildDialog();this.buildHighlight();this.reposition();this.render()}tidyUp(){this.removeById("autobem-dialog");this.removeById("autobem-highlight")}removeById(id){var existingElement=document.getElementById(id);if(existingElement){existingElement.parentNode.removeChild(existingElement)}}buildDialog(){this.dialog=document.createElement("div");this.form=document.createElement("form");this.title=document.createTextNode("What's this?");this.input=document.createElement("input");this.previousButton=document.createElement("button");this.nextButton=document.createElement("button");this.dialog.id="autobem-dialog";this.dialog.style.backgroundColor="white";this.dialog.style.border="solid 1px lightgrey";this.dialog.style.borderRadius="5px";this.dialog.style.position="fixed";this.dialog.style.padding="8px";this.dialog.style.transition="top 0.2s, left 0.2s";this.dialog.style.boxShadow="lightgrey 5px 5px";this.input.type="text";this.input.style.display="block";this.input.style.width="200px";this.input.style.margin="0 0 8px 0";this.input.placeholder="Description";this.previousButton.innerHTML="Previous";this.previousButton.style.float="left";this.previousButton.style.cursor="pointer";this.nextButton.innerHTML="Next";this.nextButton.style.float="right";this.nextButton.style.cursor="pointer";this.form.appendChild(this.title);this.form.appendChild(this.input);this.dialog.appendChild(this.form);this.dialog.appendChild(this.previousButton);this.dialog.appendChild(this.nextButton);document.body.appendChild(this.dialog)}setupEventListeners(){var self=this;this.input.oninput=function(e){self.onInput(e)};this.nextButton.onclick=function(e){self.onNext(e)};this.previousButton.onclick=function(e){self.onPrevious(e)};this.dialog.onsubmit=function(e){e.preventDefault();self.onNext(e)};window.addEventListener("resize",function(e){self.reposition()})}buildHighlight(){this.highlight=document.createElement("div");this.highlight.id="autobem-highlight";this.highlight.style.position="fixed";this.highlight.style.backgroundColor="#9FC4E7";this.highlight.style.opacity=.6;document.body.appendChild(this.highlight)}currentNode(){return this.nodes[this.index]}reposition(){var dialogPosition=this.positionForDialog();this.dialog.style.top=dialogPosition.top+"px";this.dialog.style.left=dialogPosition.left+"px";var highlightPosition=this.positionForHighlight();this.highlight.style.top=highlightPosition.top+"px";this.highlight.style.left=highlightPosition.left+"px";this.highlight.style.width=highlightPosition.width+"px";this.highlight.style.height=highlightPosition.height+"px"}positionForDialog(){var node=this.currentNode();var rect=node.element.getBoundingClientRect();var win=node.element.ownerDocument.defaultView;return{top:rect.top+rect.height+win.pageYOffset+8,left:rect.left+win.pageXOffset}}positionForHighlight(){var node=this.currentNode();var rect=node.element.getBoundingClientRect();var win=node.element.ownerDocument.defaultView;return{top:rect.top+win.pageYOffset,left:rect.left+win.pageXOffset,height:rect.height,width:rect.width}}render(){this.currentNode().description=this.currentNode().defaultDescription(this.nodes);this.input.value=this.currentNode().description;this.input.focus();this.setupEventListeners();this.reposition();this.updateNextButton()}onInput(e){this.currentNode().description=e.target.value;this.updateNextButton()}updateNextButton(){this.nextButton.disabled=!this.currentNode().description;this.nextButton.innerHTML=this.index===this.nodes.length-1?"Finish":"Next"}onNext(e){if(this.nextButton.disabled){return}var oldIndex=this.index;this.index=Math.min(this.index+1,this.nodes.length-1);if(this.index!==oldIndex){this.render()}if(oldIndex===this.nodes.length-1){this.finish()}}isFinishing(){return this.index===this.nodes.length-1}finish(){document.body.removeChild(this.dialog);new CSSExporter(this.nodes).export()}onPrevious(e){var oldIndex=this.index;this.index=Math.max(this.index-1,0);if(this.index!==oldIndex){this.render()}}}function runAutoBEM(block){var html=document.getElementsByTagName("html")[0];var styleTree=new StyleTree(html,block);new Dialog(styleTree.root,styleTree.list).start()}